---
title: "airparif"
author: "Sarah Hosking"
date: "December 10, 2016"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(tidyverse)
library(GGally)

library(reshape2) #plot missing vals

theme_set(theme_bw())

```

## Read files


```{r air pollution in paris Aug 2017}

airparif <- read.csv("airparif_centre_13_8_2017.csv", sep = ";", stringsAsFactors = FALSE)

#airparif <- read.csv("airparif_centre_8_12_2016.csv", sep = ";", stringsAsFactors = FALSE)

#airparif <- read.csv("airparif_centre_8_12_2016.csv", sep = ";")

dim(airparif)
str(airparif)
summary(airparif)
head(airparif,20)
tail(airparif,20)

```

```{r convert col types}

airparif[,3:7] <- lapply(airparif[,3:7], as.numeric)
str(airparif)

```

```{r}

head(airparif)
```

There seems to be a LOT of NA values

```{r}
# credit to:
# http://www.njtierney.com/r/missing%20data/rbloggers/2015/12/01/ggplot-missing-data/
missing.data <- function(x){
  
  x %>% 
    is.na %>%
    melt %>%
    ggplot(data = .,
           aes(x = Var2,
               y = Var1)) +
    geom_raster(aes(fill = value)) +
    scale_fill_grey(name = "",
                    labels = c("Present","Missing")) +
    theme_minimal() + 
    theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
    labs(x = "Variables in Dataset",
         y = "Rows / observations")
}

missing.data(airparif[,1:7])
```


## Prepare the data

Where is the NA date?

```{r}

which(is.na(airparif$date))

# look at vals before & after this row
airparif[211:214,]

# okay this happened on '29/07/2011' @ 20h
# TODO: replace with locf (from dplyr?)
airparif$date[213] <- '29/07/2011'
airparif[211:214,]

```


Let's convert the date var into a true Date type variable

```{r convert str date into date}

airparif$date <- as.Date(airparif$date, format = "%d/%m/%Y")
str(airparif)

```

Then we can use tidyR's `separate` function to split these into day, month and year variables.

```{r split date into y m d vars}

# remove 1st row
airparif <- airparif[-1,]
str(airparif)

```

```{r add y m d}

# make a copy
 airparif$date2 <- airparif$date
# 
 airparif <- separate(airparif, date2, c("year", "month", "day"), sep="-")
# str(airparif)

#  Convert year month day to ordered factor
 airparif[,8:10] <- lapply(airparif[,8:10], factor, ordered = TRUE)
# str(airparif)

```

```{r save as rds}

write_rds(airparif, "airparif.rds")

```


# What are we looking at?

First let's understand what these pollutants are

```{r}

# get column names
names(airparif)


```


What the abbreviations mean:

* `PM25` = fine particulate < 2.5 mm
* `PM10` = fine particulate < 10 mm
* `03` = Ozone
* `NO2` = Nitrogen Dioxide (Azote)
* `CO` = Carbon monoxide

# Explore data

Ok, so let's look at the data!

## ggplot histogram


### Adding layers

What's the median & mean for `PM10`?

```{r add med & avg to hist}

# PROBLEM: why doesn't this work?
med <- median(airparif$PM10)
avg <- mean(airparif$PM10)

# SOLUTION: NA vals
# med <- median(airparif$PM10, na.rm = TRUE)
# avg <- mean(airparif$PM10, na.rm = TRUE)

p <- ggplot(data = airparif, aes(PM10)) +
  geom_histogram(binwidth = 5) + 
  geom_vline(xintercept = med, col = 'red', linetype = 'dotted') +
  geom_vline(xintercept = avg, col = 'blue', linetype = 'dashed')

p


```


## Aesthetics

You can map aesthetic properties like `shape`, `fill` and `colour` to variables. 

Notice what gets produced automatically when you do this.

```{r use aesthetics to segment}



#p <- qplot(PM10, data = airparif, geom = "freqpoly")
p <- ggplot(aes(PM10, colour = year), data = airparif)
p + geom_freqpoly()

```


```{r facet by month, year}
p + 
  geom_freqpoly() +
  scale_x_continuous(limits = c(0,150)) +
  facet_wrap(~ month)

```

### Boxplots

```{r boxplot}

#p <- qplot(data = airparif, x = year, y = PM10, geom = "boxplot") 
p <- ggplot(data = airparif, aes(x = year, y = PM10))
p + geom_boxplot()

```


```{r boxplot + points}

p + 
  geom_boxplot() +
  geom_point()

```
That's not very helpful.

```{r boxplot + jitter}

# use jitter to reduce overlap
p + 
  geom_boxplot() +
  geom_jitter()


```


```{r boxplot + jitter}

# tweak opacity to better show distribution
p + 
  geom_boxplot() +
  geom_jitter(alpha = 1/100)

# reduce width of jitter
p + 
  geom_boxplot() +
  geom_jitter(alpha = 1/100, width = 0.2)



```


```{r}
p + scale_y_continuous(limits = c(0,30))
```


Compare with using "coord_cartesian"

```{r}

p + coord_cartesian(ylim = c(0,30))

```


## Scatterplots

How has pollution evolved over time?

```{r scatterplot}

p <- ggplot(data = airparif, aes(x = date, y = PM10)) +
  geom_point(alpha = 1/50) 
p  

```

```{r}

# add a trend line
lm <- geom_smooth(method = "lm")
p + lm
```

```{r}

p <- ggplot(airparif, aes(heure, PM10))
p + 
  geom_jitter(alpha = 1/20) + 
  geom_smooth()

```

HOw much does this vary by month?

```{r}

p + 
  geom_jitter(alpha = 1/50) +
  geom_smooth() +
  facet_wrap(~month)




```



How does this compare with NO2?

```{r}

p <- ggplot(airparif, aes(date, NO2))
p + geom_point(alpha = 1/50)

```

Is there a correlation between `NO2` and `PM10`?

```{r}

p <- ggplot(airparif, aes(PM10, NO2))
p + geom_point(alpha = 1/20)

```

# EXERCISE

What year did those outliers occur?

```{r}
p + geom_point(alpha = 1/2, aes(colour = year))

```

Which month?

```{r}
p + geom_point(alpha = 1/2, aes(colour = year)) +
  facet_wrap(~month)

```


What hour did they occur?

```{r}

p + geom_point(alpha = 1/2, aes(colour = heure))

```


```{r}

p + geom_point(alpha = 1/2, aes(colour = as.factor(heure)))

```

This is hard to read


```{r convert columns to numeric, eval=FALSE, include=FALSE}

# create list of cols to convert
cols<- names(airparif)
cols.num <- cols[3:length(airparif)]

# convert pollutants to numeric
airparif[cols.num] <- lapply(airparif[cols.num], as.numeric)


# this converts everything to a list
# need to reconvert to df
airparif <- data.frame(airparif)
str(airparif)
summary(airparif)


# plot again
qplot(data = airparif, PM10)

# increase # of bins
qplot(data = airparif, PM10, binwidth = 5)


```

Now let's try faceting

```{r facets}
# by year
qplot(data = airparif, PM10, binwidth = 5, facets = ~year)

# remove the NA values
qplot(data = na.omit(airparif), PM10, binwidth = 5, facets = ~year)

# what were the max values for each year?
tapply(airparif$PM10, airparif$year, summary)

ggplot(aes(PM10), data = na.omit(airparif)) +
  geom_histogram(binwidth = 5) +
  facet_wrap(~year, ncol = 1)

```


Looking at the other variables

```{r}

qplot(data = na.omit(airparif), PM25, binwidth = 5, facets = ~heure)
qplot(data = airparif, NO2, binwidth = 7, facets = ~heure)
qplot(data = airparif, O3, binwidth = 3, facets = ~year)
qplot(data = na.omit(airparif), CO, facets = ~year)


```

```{r boxplots}

ggplot(aes(x = as.factor(year), y = PM10), data = na.omit(airparif)) +
  geom_boxplot(na.rm = TRUE)

ggplot(aes(x = as.factor(year), y = PM25), data = airparif) +
  geom_boxplot()

ggplot(aes(x = as.factor(year), y = NO2), data = airparif) +
  geom_boxplot()

ggplot(aes(x = as.factor(year), y = O3), data = airparif) +
  geom_boxplot()

```



## Comparing variables

```{r}

# create a sample
set.seed(888)
sample <- subset(airparif, select = c(PM10, PM25, NO2, O3, month))
sample <- sample[sample(1:nrow(sample),1000),]

# look at correlations
# ggpairs(sample, axisLabels = 'internal',
#         lower = list(continuous = wrap("smooth", alpha=0.2, shape = I('.'))), 
#         upper = list(combo = wrap("box", outlier.shape = I('.'))))

ggpairs(data=sample, # data.frame with variables
        #columns=1:3, # columns to plot, default to all.
        title="pollution") # title of the plot
```

## Look at summaries

```{r gather & spread}

# create function to set pollution levels

# first, define thresholds for diff pollutants
#levels <- c()
levels.PM10 <- c(0,15,30,50,100)
levels.PM25 <- c(0,10,20,30,60)
levels.NO2 <- c(0,50,100,200,400)
levels.O3 <- c(0,60,120,180,240)



upper = 0
pollution.level <- function(x, levels, labs, upper = upper, 
                            sep = "-", above.char = "+") {

labs <- c("very low", "low", "medium", "high", "very high") 

 cut(floor(x), 
     breaks = c(levels, Inf),
     right = FALSE, 
     labels = labs)
}

```

```{r summary df}

airparif.long <- airparif %>% 
  #select(-year,-month, -day) %>% 
  gather(PM10, PM25, NO2, O3, CO, 
         key = 'pollutant', value = 'value', 
         na.rm = TRUE) %>% 
  group_by(date, pollutant) %>% 
  summarise(mean = mean(value))
 
  
```

```{r}

levels <-  airparif.long %>%
  group_by(date, pollutant) %>% 
  #mutate_all(funs('level' = pollution.level(.))) %>% 
  mutate_all(funs(pollution.level))

```

```{r}
airparif.levels <- airparif.long %>% 
  ungroup() %>%
  mutate(level =
           ifelse(pollutant == 'PM10', pollution.level(mean, levels.PM10),
               ifelse(polllutant == 'PM25', pollution.level(mean, levels.PM25), 'NA')))
              #   ifelse(polllutant == 'NO2', pollution.level(mean, levels.NO2),
              #          pollution.level(mean, levels.O3)))))


```

```{r save airparif.long}

write_rds(airparif.long, "airparif_long.rds")

```



```{r time series chart}

# plot trend

ggplot(aes(date, max, colour = pollutant), 
       data = airparif.long) +
         geom_line()
  

```
Wow, carbon monoxide (`CO`) is level of magnitude higher.

For now, let's only examine fine particulate

```{r}

# only plot PM pollutants
labs <- c("very low", "low", "medium", "high", "very high") 
particles <- airparif.long %>% 
  filter(pollutant %in% c('PM10', 'PM25')) %>% 
  mutate(level = 
           ifelse(pollutant == 'PM10', pollution.level(mean, levels.PM10), pollution.level(mean, levels.PM25))) %>% 
  mutate(level = labs[level])

p <- ggplot(particles, aes(date, mean))

p + 
  geom_line(aes(y = mean, colour = pollutant)) + 
  scale_x_date(date_breaks = '3 months', date_labels = "%b %d")
  
```

Need to add some more context to this plot. What are the levels for medium, high, and very high pollution?

So how many days have their been for each level?




```{r}


levels.test <-  airparif.long %>%
  select(1:3) %>% 
  ungroup() %>% 
  mutate('level' = 
           ifelse(grepl("PM10", pollutant), pollution.level(mean, levels.PM10),
                  ifelse(grepl("PM25", pollutant), pollution.level(mean, levels.PM25), "NA")))
#%>% 
  #mutate_all(funs(pollution.level))


```

```{r level NO2 only}

levels <- c(0,50,100,200,400)
levels.df <- as_data_frame(levels)

NO2.levels <- airparif.long %>% 
  filter(pollutant == 'NO2') %>% 
  select(date:mean) %>% 
  mutate('level' = pollution.level(mean, levels))



```

```{r plot NO2 means by year}

levels.NO2 <- c(0,50,100,200,400)
levels <- levels.NO2

p <- ggplot(NO2.levels, aes(x = as.factor(month(date)), y = mean))
p <- p + geom_boxplot()
#p <- p + facet_wrap(~year(date), nrow = 1)
p + geom_hline(yintercept = levels)

```





```{r level PM10 only}

levels.PM10 <- c(0,15,30,50,100)
levels <- levels.PM10

PM10.levels <- airparif.long %>% 
  filter(pollutant == 'PM10') %>% 
  select(date:mean) %>% 
  mutate('level' = pollution.level(mean, levels))


p %+% PM10.levels + geom_hline(yintercept = levels)



```

```{r make hline a var}

hl <- geom_hline(yintercept = levels,  linetype = 2)

p + hl
```
```{r}
levels <- levels.PM25
p <- p %+% PM25.levels
p + geom_hline(yintercept = levels)

```

```{r level O3 only}

levels <- c(0,60,120,180,240)

ozone.levels <- airparif.long %>% 
  filter(pollutant == 'O3') %>% 
  select(date:mean) %>% 
  mutate('level' = pollution.level(mean, levels))


p <- ggplot(ozone.levels, aes(level)) +
  geom_bar()

(p + facet_wrap(~month(date)))
```

```{r level PM25 only}

levels <- c(0,10,20,30,60)

PM25.levels <- airparif.long %>% 
  filter(pollutant == 'PM25') %>% 
  select(date:mean) %>% 
  mutate('level' = pollution.level(mean))


p <- ggplot(PM25.levels, aes(level)) +
  geom_bar()
p
```

So there are different annaul patterns that differ by pollutant. 
What about time of day?

```{r}
airparif.hlong <- airparif %>% 
  #select(-year,-month, -day) %>% 
  gather(PM10, PM25, NO2, O3, CO, 
         key = 'pollutant', value = 'value', 
         na.rm = TRUE) %>% 
  group_by(date, month(date), heure, pollutant) %>% 
  summarise(mean = mean(value))
```

what's the distributions by hour?

```{r}

levels <- c(0,50,100,200,400)
h <- geom_hline(yintercept = levels, linetype = 2)


NO2.hlevels <- airparif.hlong %>% 
  filter(pollutant == 'NO2') %>% 
  select(heure:mean) %>% 
  mutate('level' = pollution.level(mean, levels))

#p %+% NO2.levels + aes(x = as.factor(heure))

p <- ggplot(NO2.hlevels, aes(x = as.factor(heure), y = mean))
p <-p + geom_boxplot()
p

p <- p + facet_wrap(~month(date))
p
  
```


```{r}

levels.O3 <- c(0,60,120,180,240)
levels <- levels.O3

O3.hlevels <- airparif.hlong %>% 
  filter(pollutant == 'O3') %>% 
  select(heure:mean) %>% 
  mutate('level' = pollution.level(mean, levels))

p %+% O3.hlevels
```


```{r}

levels.PM10 <- c(0,15,30,50,100)
levels <- levels.PM10

PM10.hlevels <- airparif.hlong %>% 
  filter(pollutant == 'PM10') %>% 
  select(heure:mean) %>%
  mutate('level' = pollution.level(mean, levels))

p %+% PM10.hlevels
```

```{r PM25 hourly}

levels.PM25 <- c(0,10,20,30,60)
levels <- levels.PM25

PM25.hlevels <- airparif.hlong %>% 
  filter(pollutant == 'PM25') %>% 
  select(heure:mean) %>% 
  mutate('level' = pollution.level(mean, levels))

plt <- p %+% PM25.hlevels
plt
```

```{r plot levels}

p <- ggplot(data = PM10.hlevels, aes(x = level, y = year(date))) +
  geom_bar()
p


```


##Merge tables

```{r}

all.levels <- left_join(all.levels, ozone.levels, by = 'date')
all.levels <- left_join(all.levels, NO2.levels, by = 'date')
head(all.levels)
```


So if we look at daily averages, Paris doesn't seem so polluted, does it? 

But 
```{r}

```

```{r save levels}

write_rds(levels, "levels.rds")

```

How many days at each level for each pollutant?

```{r}

p <- ggplot(levels, aes(median, fill = pollutant))
p + geom_bar()
```
Stacked bars can be hard to read. Let's change the bar position to `dodge`.

```{r}
p + 
  geom_bar(position = 'dodge')

```

Still hard to compare level distrubtion of the different pollutants. We can facet by pollutant.

```{r}
p + 
  geom_bar(position = 'dodge') +
  facet_wrap(~pollutant)

```

Does this change from year to year? 

We'll need to add a year column.
We can do this again with dplyr and include ggplot using the pipe

```{r}

levels %>% 
  # separate(date, c("year", "month", "day"), sep="-") %>% 
  mutate('year' = year(date)) %>% 
  ggplot(aes(median, fill = pollutant)) + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ year)

```

Not really. 

## YOUR TURN: What about by month?

BONUS: Look up dplyr's `separate()` function in the help.

```{r}

levels %>% 
  separate(date, c("year", "month", "day"), sep="-") %>% 
  ggplot(aes(median, fill = pollutant)) + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ month)

```

Hard to tell, let's free up the y scale for each pollutant

```{r}

levels %>% 
  separate(date, c("year", "month", "day"), sep="-") %>% 
  ggplot(aes(median, fill = pollutant)) + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ month, scales = "free_y")

```

Let's try removing 2011

```{r}
levels %>% 
  separate(date, c("year", "month", "day"), sep="-") %>% 
  filter(year != 2011) %>% 
  ggplot(aes(median, fill = pollutant)) + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ month, scales = "free_y")

```

what about by hour?

```{r}

levels %>% 
  ggplot(aes(median, fill = pollutant)) + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ heure)
```


```{r}

# how many days of each level for each pollutant per year?
levels.count <- levels %>%
  group_by(year(date), pollutant, median) %>% 
  summarise('count' = n())
```



```{r}

#levels <- cbind(summary[1], x)

# gather(cases, "year", "n", 2:4)
#levels.long <- gather(levels, "pollutant", "level", 3:7)

#spread(pollution, size, amount)

# reshaping to long format
#count.levels.l <- levels.long %>% 
  # collapse pollutant columns into one
  # create year column
  # mutate('year' = year(date)) %>% 
  # create new 'level' column
  #gather(pollutant, level, 2:7) %>% 
  #group_by(year,pollutant, level) %>% 
  # count number of days at each level
  #summarise(n = n())

str(count.levels.l)

# need to conver 'level' col to ordered factor
count.levels.l$level <- ordered(count.levels.l$level, 
                                levels = c("very low", "low", "medium", 
                                           "high", "very high", "NA"))

# now reshape to wide format, count days, 
# fill missing vals with zeros
count.levels.w <- count.levels.l %>%
  spread(level, n, fill=0)

# and let's gather once more
test <- count.levels.w %>%
  ungroup() %>%
  group_by(year) %>%
  gather(year, pollutant, level, 3:8)
  


```

Ok, finally. Time to plot. 

```{r}

ggplot(data = filter(count.levels.l, year != 2011), aes(x=level, y=n,
                                  group = pollutant, 
                                  fill = pollutant)) +
  geom_bar(stat="identity") + 
  scale_x_discrete("Level") +
  scale_y_continuous("Number of Days") +
  facet_wrap(~pollutant, ncol=2) +
  #facet_wrap(~year)
```

Hmmmm...the problem is, the counts don't make sense, particularly as we haven't faceted by year.

Time to look at a breakdown

```{r}


```

