---
title: "airparif"
author: "Sarah Hosking"
date: "December 10, 2016"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(ggplot2)
library(lubridate)
library(tidyverse)
library(GGally)

library(reshape2) #plot missing vals

theme_set(theme_bw())

```

## R Markdown


```{r air pollution in paris Dec 2016}
airparif <- read.csv("airparif_centre_8_12_2016.csv", sep = ";", stringsAsFactors = FALSE)
#airparif <- read.csv("airparif_centre_8_12_2016.csv", sep = ";")

dim(airparif)
str(airparif)
summary(airparif)
head(airparif,20)
tail(airparif,20)

```

```{r convert col types}

airparif[,3:7] <- lapply(airparif[,3:7], as.numeric)
str(airparif)

```

```{r}

head(airparif)
```

There seems to be a LOT of NA values

```{r}
# credit to:
# http://www.njtierney.com/r/missing%20data/rbloggers/2015/12/01/ggplot-missing-data/
ggplot_missing <- function(x){
  
  x %>% 
    is.na %>%
    melt %>%
    ggplot(data = .,
           aes(x = Var2,
               y = Var1)) +
    geom_raster(aes(fill = value)) +
    scale_fill_grey(name = "",
                    labels = c("Present","Missing")) +
    theme_minimal() + 
    theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
    labs(x = "Variables in Dataset",
         y = "Rows / observations")
}

ggplot_missing(airparif[,1:7])
```


## Prepare the data

Where is the NA date?

```{r}

which(is.na(airparif$date))

# look at vals before & after this row
airparif[211:214,]

# okay this happened on '29/07/2011' @ 20h
# TODO: replace with locf (from dplyr?)
airparif$date[213] <- '29/07/2011'
airparif[211:214,]

```


Let's convert the date var into a true Date type variable

```{r convert str date into date}

airparif$date <- as.Date(airparif$date, format = "%d/%m/%Y")
str(airparif)

```

Then we can use tidyR's `separate` function to split these into day, month and year variables.

```{r split date into y m d vars}

# remove 1st row
airparif <- airparif[-1,]

# make a copy
airparif$date2 <- airparif$date

airparif <- separate(airparif, date2, c("year", "month", "day"), sep="-")
str(airparif)

#fix malformed date for row 212
#airparif$date[212] <- "2011-07-20"

#try again
#airparif <- separate(airparif, date, c("year", "month", "day"), sep="-")

```

Convert year month day to ordered factor

```{r}
airparif[,8:10] <- lapply(airparif[,8:10], factor, ordered = TRUE)
str(airparif)
```

## Distributions

Time to look at the distributions

First let's understand what these pollutants are

```{r}

# get column names
names(airparif)


```


What the abbreviations mean:

* `PM25` = fine particulate > 2.5 mm
* `PM10` = fine particulate > 10 mm
* `03` = Ozone
* `NO2` = Nitrogen Dioxide (Azote)
* `CO` = Carbon monoxide

# EDA

Ok, so let's look at the data!

## qplot histogram

```{r qplot hists}

qplot(PM10, data = airparif)

# increase bins
qplot(data = airparif, PM10, binwidth = 5)

```

## ggplot histogram

We can do the same thing with ggplot

```{r}

ggplot(data = airparif, aes(PM10)) +
  geom_histogram(binwidth = 5)
```

### When to use qplot, when to use ggplot?

```{r}

a <- c('A', 'B', 'C')
b <- c(1, 2, 3)

# qplot
q <- qplot(a,b)
q

```

```{r}

d <- data.frame(a,b)

# ggplot
p <- ggplot(data = d, aes(a,b)) +
  geom_point()
p


```

```{r}

# change var
a <- c('X','Y','Z')

# with qplot
q
```

```{r}

# with ggplot
p
```




### Adding layers

What's the median & mean for `PM10`?

```{r add med & avg to hist}

# PROBLEM: why doesn't this work?
med <- median(airparif$PM10)
avg <- mean(airparif$PM10)

# SOLUTION: NA vals
# med <- median(airparif$PM10, na.rm = TRUE)
# avg <- mean(airparif$PM10, na.rm = TRUE)

p <- ggplot(data = airparif, aes(PM10)) +
  geom_histogram(binwidth = 5) + 
  geom_vline(xintercept = med, col = 'red', linetype = 'dotted') +
  geom_vline(xintercept = avg, col = 'blue', linetype = 'dashed')

p


```


## Aesthetics

You can map aesthetic properties like `shape`, `fill` and `colour` to variables. 

Notice what gets produced automatically when you do this.

```{r use aesthetics to segment}

#p <- qplot(PM10, data = airparif, geom = "freqpoly")
p <- ggplot(aes(PM10, colour = year), data = airparif)
p + geom_freqpoly()

```


```{r facet by month, year}
p + 
  scale_x_continuous(limits = c(0,150)) +
  facet_wrap(~ month)

```

### Boxplots

```{r boxplot}

p <- qplot(data = airparif, x = year, y = PM10, geom = "boxplot") 
#p <- qplot(data = airparif, x = 1, y = PM10, geom = "boxplot")
p

```


```{r boxplot + points}

p + geom_point()

```

```{r boxplot + jitter}

# use jitter to reduce overlap
p + geom_jitter()


```

```{r boxplot + jitter}

# tweak opacity to better show distribution
p + geom_jitter(alpha = 1/100)

# reduce width of jitter
p + geom_jitter(alpha = 1/100, width = 0.2)



```


```{r}
p + scale_y_continuous(limits = c(0,50))
```


Compare with using "coord_cartesian"

```{r}

p + coord_cartesian(ylim = c(0,50))

```


## Scatterplots

How has pollution evolved over time?

```{r scatterplot}

p <- ggplot(data = airparif, aes(x = date, y = PM10)) +
  geom_point(alpha = 1/50) 
p  

```

```{r}

# add a trend line
p + geom_smooth(method = "lm")
```

```{r}

p <- ggplot(airparif, aes(heure, PM10))
p + 
  geom_jitter(alpha = 1/20) + 
  geom_smooth()

```

HOw much does this vary by month?

```{r}

p + 
  geom_jitter(alpha = 1/50) +
  geom_smooth() +
  facet_wrap(~month)




```



How does this compare with NO2?

```{r}

p <- ggplot(airparif, aes(date, NO2))
p + geom_point(alpha = 1/50)

```

Is there a correlation between `NO2` and `PM10`?

```{r}

p <- ggplot(airparif, aes(PM10, NO2))
p + geom_point(alpha = 1/20)

```

# EXERCISE

What year did those outliers occur?

```{r}
p + geom_point(alpha = 1/2, aes(colour = year))

```

Which month?

```{r}
p + geom_point(alpha = 1/2, aes(colour = year)) +
  facet_wrap(~month)

```


What hour did they occur?

```{r}

p + geom_point(alpha = 1/2, aes(colour = heure))

```


```{r}

p + geom_point(alpha = 1/2, aes(colour = as.factor(heure)))

```

This is hard to read


```{r convert columns to numeric, eval=FALSE, include=FALSE}

# create list of cols to convert
cols<- names(airparif)
cols.num <- cols[3:length(airparif)]

# convert pollutants to numeric
airparif[cols.num] <- lapply(airparif[cols.num], as.numeric)


# this converts everything to a list
# need to reconvert to df
airparif <- data.frame(airparif)
str(airparif)
summary(airparif)


# plot again
qplot(data = airparif, PM10)

# increase # of bins
qplot(data = airparif, PM10, binwidth = 5)


```

Now let's try faceting

```{r facets}
# by year
qplot(data = airparif, PM10, binwidth = 5, facets = ~year)

# remove the NA values
qplot(data = na.omit(airparif), PM10, binwidth = 5, facets = ~year)

# what were the max values for each year?
tapply(airparif$PM10, airparif$year, summary)

ggplot(aes(PM10), data = na.omit(airparif)) +
  geom_histogram(binwidth = 5) +
  facet_wrap(~year, ncol = 1)

```


Looking at the other variables

```{r}

qplot(data = na.omit(airparif), PM25, binwidth = 5, facets = ~heure)
qplot(data = airparif, NO2, binwidth = 7, facets = ~heure)
qplot(data = airparif, O3, binwidth = 3, facets = ~year)
qplot(data = na.omit(airparif), CO, facets = ~year)


```

```{r boxplots}

ggplot(aes(x = as.factor(year), y = PM10), data = na.omit(airparif)) +
  geom_boxplot(na.rm = TRUE)

ggplot(aes(x = as.factor(year), y = PM25), data = airparif) +
  geom_boxplot()

ggplot(aes(x = as.factor(year), y = NO2), data = airparif) +
  geom_boxplot()

ggplot(aes(x = as.factor(year), y = O3), data = airparif) +
  geom_boxplot()

```



## Comparing variables

```{r, eval=FALSE, include=FALSE}

# create a sample
set.seed(888)
sample <- subset(airparif, select = c(PM10, PM25, NO2, O3, CO))
sample <- sample[sample(1:nrow(sample),2500),]

# look at correlations
ggpairs(sample, axisLabels = 'internal',
        lower = list(continuous = wrap("smooth", alpha=0.2, shape = I('.'))), 
        upper = list(combo = wrap("box", outlier.shape = I('.'))))
```

## Look at summaries

```{r summary df}

airparif.long <- airparif %>% 
  select(-year,-month, -day) %>% 
  gather(PM10, PM25, NO2, O3, CO, 
         key = 'pollutant', value = 'value', 
         na.rm = TRUE) %>% 
  group_by(date, pollutant) %>% 
  summarise(mean = mean(value),
            median = median(value),
            max = max(value))
  



```

```{r time series chart}

# plot trend

ggplot(aes(date, mean, colour = pollutant), 
       data = airparif.long) +
         geom_line()
  

```
Wow, carbon monoxide (`CO`) is level of magnitude higher.

For now, let's only examine fine particulate

```{r}

# only plot PM pollutants
particles <- airparif.long %>% 
  filter(pollutant %in% c('PM10', 'PM25')) 


p <- ggplot(particles, aes(date, mean))

p + 
  geom_line() +
  geom_line(aes(y = median, colour = 'red'))
  
```


Need to add some more context to this plot. What are the levels for medium, high, and very high pollution?

```{r adding h lines}

p <- ggplot(aes(date, PM10), data = summary) +
  geom_line() +
  geom_hline(yintercept = 25, col = "green") +
  geom_hline(yintercept = 50, col = "yellow") +
  geom_hline(yintercept = 75, col = "orange") +
  geom_hline(yintercept = 100, col = "red")

p
```

So how many days have their been for each level?

```{r gather & spread}

# add a levels column to summary

#x <- list(1:3, 4:6)
#do.call(cbind, lapply(x, function(i) rowMeans(dat[, i])))

x = summary[1:6]
x

# create function to set pollution levels
pollution.level <- function(x, lower = 0, upper = 100, 
                            by = 25, sep = "-", above.char = "+") {
 labs <- c("very low", "low", "medium", "high", "very high")

 cut(floor(x), 
     breaks = c(seq(lower, upper, by = by), Inf),
     right = FALSE, 
     labels = labs)
}

# apply pollution leveller fun. to all the columns of x
x[2:5] <- lapply(x[2:5], pollution.level)


```

```{r}
levels <-  airparif.long %>%
  group_by(date, pollutant) %>% 
  #mutate_all(funs('level' = pollution.level(.))) %>% 
  mutate_all(funs(pollution.level)) %>% 
  mutate('yr' = year(date)) 
```

```{r}

p <- ggplot(levels, aes(median, fill = pollutant))
p + geom_bar()
```
Stacked bars can be hard to read. Let's change the bar position to `dodge`.

```{r}
p + 
  geom_bar(position = 'dodge')

```

Still hard to compare level distrubtion of the different pollutants. We can facet by pollutant.

```{r}
p + 
  geom_bar(position = 'dodge') +
  facet_wrap(~pollutant)

```

Does this change from year to year?

```{r}
p + 
  geom_bar(position = 'dodge') +
  facet_grid(pollutant ~ yr)

```

```{r}

# how many days of each level for each pollutant per year?
levels.count <- levels %>%
  group_by(year(date), pollutant, median) %>% 
  summarise('count' = n())
```



```{r}

#levels <- cbind(summary[1], x)

# gather(cases, "year", "n", 2:4)
#levels.long <- gather(levels, "pollutant", "level", 3:7)

#spread(pollution, size, amount)

# reshaping to long format
#count.levels.l <- levels.long %>% 
  # collapse pollutant columns into one
  # create year column
  # mutate('year' = year(date)) %>% 
  # create new 'level' column
  #gather(pollutant, level, 2:7) %>% 
  #group_by(year,pollutant, level) %>% 
  # count number of days at each level
  #summarise(n = n())

str(count.levels.l)

# need to conver 'level' col to ordered factor
count.levels.l$level <- ordered(count.levels.l$level, 
                                levels = c("very low", "low", "medium", 
                                           "high", "very high", "NA"))

# now reshape to wide format, count days, 
# fill missing vals with zeros
count.levels.w <- count.levels.l %>%
  spread(level, n, fill=0)

# and let's gather once more
test <- count.levels.w %>%
  ungroup() %>%
  group_by(year) %>%
  gather(year, pollutant, level, 3:8)
  


```

Ok, finally. Time to plot. 

```{r}

ggplot(data = filter(count.levels.l, year != 2011), aes(x=level, y=n,
                                  group = pollutant, 
                                  fill = pollutant)) +
  geom_bar(stat="identity") + 
  scale_x_discrete("Level") +
  scale_y_continuous("Number of Days") +
  facet_wrap(~pollutant, ncol=2) +
  #facet_wrap(~year)
```

Hmmmm...the problem is, the counts don't make sense, particularly as we haven't faceted by year.

Time to look at a breakdown

```{r}


```

